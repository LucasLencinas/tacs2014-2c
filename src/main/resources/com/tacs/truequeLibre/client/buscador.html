<html>
	<head><title>Test API MercadoLibre</title></head>
	<body>
		<div style="display: inline-block;  padding: 10px;">	
			<input type="text" id="ml-search-input"/>
			<input type="button" id="ml-search-btn" value="Buscar"/>
		</div>	
		<form action="/truequeLibre/items" method="POST">
			<div style=" border: solid 2px black; display: inline-block;  padding: 10px; background-color: lightgray;">				
				Id: <input type="text" id="ml_id" name="ml_id" readonly="true"/>
				Permalink: <input type="text" id="ml_permalink" name="ml_permalink" readonly="true" style="width:400px;"/>	
			</div>	
			<input type="hidden" id="title" name="title">	
			<input type="hidden" id="description" name="description">			
			<input type="submit" value="Agregar a Mi Lista">
		</form>

		<a href="#" id="ml-prev-page">Anterior</a>
		<a href="#" id="ml-next-page" style=" position: absolute;right: 0px; margin-right: 20;">Siguiente</a>
		<a href="/items" id="itemsPage">Items</a>		<!-- ACA PONGO UN LINK A /ITEMS PARA PROBAR LA UNION ENTRE EL HTML Y LOS .JAVA -->
		<table id="ml-results" width="100%" style="margin-top:20px;"></table>

		<!- Para no meter un string en el javascript escribi el formato en una tabla oculta ->
		<table style="display:none;">
			<tr id='ml-item-template' style="display:none;">				
				<td> <input type='radio' name='ml-item' class="ml-item-radio"> 	</td>							
				<td> <img src='%THUMBNAIL%'/></td>							
				<td> %TITLE%</td>	
				<td> <a href="%PERMALINK%">%PERMALINK%</a></td>							
			</tr>
		</table>

		<h1>Grupo 4</h1>
		<h2>Entrega 1</h2>
		<h3>Paths disponibles:</h3>
		<a href='items'> GET \\items </a><br>
		<a href='items\\1'>GET \\items\\{item_id}</a><br>
		<a href='items\\new'>GET \\items\\new</a>
		<br>
		POST \\items <br>
		<a href='items\\1\\edit'>
		GET \\items\\{item_id}\\edit</a><br>
		PUT \\items\\{item_id}<br>
		DELETE \\items\\{item_id}<br>
		
		<a href='trueques'> GET \\trueques </a><br>
		<a href='trueques\\solicitudes'> GET \\trueques\\solicitudes </a><br>
		<a href='items\\1'>GET \\trueques\\{trueque_id}</a><br>
		<a href='trueques\\new'>GET \\trueques\\new</a><br>
		POST \\trueques <br>
		PUT \\trueques\\{trueque_id}\\accept<br>
		PUT \\trueques\\{trueque_id}\\reject<br>
		<p><b>Notas:</b><br> 
		Usar cualquier n&uacute;mero como id. <br>Los par&aacute;metros de POST y 
		PUT deben enviarse con x-www-form-urlencoded.<br>Los par&aacute;metros que 
		aceptan se pueden ver en el \\new correspondiente.</p>



	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		
		<script>
			/*Clase MLSearch. Recibe la tabla en la que debe cargar los resultados y el formato de los elementos*/
			var MlSearch = function(table, template){
				this.template = template; 
				this.table = $(table);
				var that = this;

				/*
					query: String a buscar
					limit: Elementos por pagina
					page: PÃ¡gina
				*/
				this.search = function(query, limit, page){
					$.ajax({
					  dataType: "json",
					  url: "https://api.mercadolibre.com/sites/MLA/search",
					  data: {q:query, offset: limit*page, limit: limit},
					  success: fill_table									
					});
				}


				this.set_page = function(page){
					if(page<0){
						page=0
					}else{
						var max_page = that.query_result.paging.total / that.query_result.paging.limit;
					 	if(page>max_page) page = max_page;	
					}
					that.search(that.query_result.query, that.query_result.paging.limit, page)
				}

				this.next_page = function(){
					that.set_page(that.query_result.paging.offset/that.query_result.paging.limit + 1);
				}
				this.prev_page = function(){
					that.set_page(that.query_result.paging.offset/that.query_result.paging.limit - 1);
				}


				/*Private*/
				function fill_table (data){
					that.table.html("");
					that.query_result = data;
					$.each(data.results, function(i,r){
						that.table.append(fill_item(r));
					});
				}

				function fill_item(ml_item){
					var item =  $(this.template
									.replace(/%TITLE%/g, ml_item.title)
									.replace(/%THUMBNAIL%/g, ml_item.thumbnail)
									.replace(/%PERMALINK%/g, ml_item.permalink));
					item.data(
							{	
								"id": ml_item.id,
								"permalink": ml_item.permalink, 
								"thumbnail": ml_item.thumbnail,
								"title": ml_item.title,
							}
						);
					return item;
				}
		
				return this;
			
			}


			/* Crea una instancia de MLSearch y setea los handlers a los botones */

			var ml = MlSearch("#ml-results", "<tr class='ml-item' style='background-color: lightgray'>" + $("#ml-item-template").html()+"</tr>");
	
			$("#ml-search-btn").click(
				function(){
					ml.search( $("#ml-search-input").val(), 5);
				}
			);
			
			$("#ml-prev-page").click(function(e){
				e.preventDefault();
				ml.prev_page();
			});

			$("#ml-next-page").click(function(e){
				e.preventDefault();
				ml.next_page();
			});

			/* Guarda en campos del form el permalink y la id del item seleccionado */
			$(document).on("click","#ml-results .ml-item-radio",function(e){
				var ml_item = $(e.target).closest("tr.ml-item");
				$("#ml_permalink").val(ml_item.data().permalink);
				$("#ml_id").val(ml_item.data().id);
				$("#title").val(ml_item.data().title);
				$("#description").val("Descripcion hardcodeada");
			});
		</script>
	</body>

</html>